{% extends 'base.html' %}

{% block header %}Game{% endblock %}
{% block title  %}Game{% endblock %}


{% block content %}
    <!-- HTML to display before game starts -->
    <div class="before_start">
      <h1>Game Not Started</h1>
      <button onclick="console.log('attempting to send start game request'); io.connect('http://' + document.domain + ':' + location.port).emit('game start')">Start game</button>
    </div>
    <!--
    <button onclick="console.log('attempting to send end game request'); io.connect('http://' + document.domain + ':' + location.port).emit('game end')">End game</button>
  -->

    <!-- HTML to display while game in progress -->
    <div class="game" style="display:none">
      <h1>Game In Progress</h1>
      <h3 style='color: #ccc;font-size: 30px;'>No message yet..</h3>
      <div class="message_holder"></div>

      <form action="" method="POST">
          <input type="text" class="username" value="Player 1" disabled="disabled"/>
          <input type="text" class="message" placeholder="Messages"/>
          <input type="submit"/>
      </form>

    </div>

    <!-- HTML to display while voting in progress -->
    <div class="voting" style="display:none">
      <h1>Vote for who you think the bot is</h1>

      <form action="" method="POST">
          <select class="bot_guess">
          </select>
      </form>
    </div>

    <!-- HTML to display while votes are being tallied -->
    <div class="tallying" style="display:none">
      <h1>Tallying votes...</h1>
    </div>


    <!-- HTML to display after game over voting in progress -->
    <div class="score" style="display:none">
      <h1>Scoreboard: will put it here</h1>
      <ol class="scoreboard"></ol>

    </div>


    <!-- Room join button
    <button onclick="console.log('attempting to send join room request'); io.connect('http://' + document.domain + ':' + location.port).emit('join', {'username': 'Player1', 'room': 1})">Click me</button>
-->


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script type="text/javascript">
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('connect', function() {
        console.log("Connected");
        socket.emit('new_connect');
        var form = $('form').on('submit', function(e) {
            e.preventDefault()
            let user_input = $('input.message').val()
            socket.emit('my event', {
                message : user_input
            } )
          $('input.message').val('').focus()
        } )
    } )


    socket.on('my response', function(msg) {
        console.log("Response")
        console.log(msg)
        if(typeof msg.user_name !== 'undefined') {
            $('h3').remove()
            $('div.message_holder').append('<div><b style="color: #000">'+msg.user_name+'</b> '+msg.message+'</div>')
        }
    })

    socket.on('game started', function() {

        console.log("Game started!");
        $("div.before_start").hide();
        $("div.game").show();
    })

    socket.on('voting started', function(num_options) {
        for (var i = 0; i < num_options; i++) {
          $("select.bot_guess").append(`<option value="Player ${i}">Player ${i}</option>`)
        };

        console.log("Voting started!");
        $("div.game").hide();
        $("div.voting").show()
    })

    socket.on('tallying votes', function() {
        console.log("Tallying votes!");
        let bot_guess = $('select.bot_guess').val()
        socket.emit("record vote", bot_guess)

        $("div.voting").hide();
        $("div.tallying").show()
    })

    socket.on('voting ended', function(scores) {
        Object.keys(scores).forEach(function(key) {
          $("ol.scoreboard").append(`<li>Player: ${key}, score: ${scores[key]}</li>`)
        })

        $("div.tallying").hide();
        $("div.score").show();
    })

    socket.on('back to start', function() {
        console.log("Back to start!");

        // Removes all messages from the previous game
        $('div.message_holder').empty();
        $("div.score").hide();
        $("div.before_start").show();
    })

    </script>

{% endblock %}
